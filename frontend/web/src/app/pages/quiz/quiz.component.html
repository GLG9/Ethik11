<div
  class="quiz-shell"
  [class.reduced-motion]="prefersReducedMotion"
  [class.results-mode]="phase === 'submitted'"
>
  <header class="quiz-header">
    <div class="header-content">
      <div class="title">
        <h1>Ethik-Quiz</h1>
        <p>Teste dein Wissen zu Plessner, Löwith, Marx, Kant und Gehlen.</p>
        <div class="planned-pill" *ngIf="statusMessage">
          <span class="dot"></span>
          <span>{{ statusMessage }}</span>
        </div>
      </div>
      <div class="meta">
        <button class="name-button stat-card" type="button" (click)="openNameModal()">
          <span class="label">Spieler:in</span>
          <span class="value">{{ playerName || 'Name festlegen' }}</span>
        </button>
        <div class="progress stat-card">
          <span class="label">Frage</span>
          <span class="value">{{ progressLabel }}</span>
        </div>
      </div>
    </div>
    <div class="header-foot">
      <div class="progress-rail" *ngIf="progressSteps.length">
        <span
          *ngFor="let step of progressSteps; let i = index"
          class="rail-dot"
          [class.completed]="i < currentIndex"
          [class.active]="i === currentIndex"
        ></span>
      </div>
    </div>
  </header>

  <aside class="sidebar">
    <nav>
      <p class="heading">Quiz</p>
      <a routerLink="/quiz" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">Fragen</a>
      <a routerLink="/quiz/leaderboard" routerLinkActive="active">Leaderboard</a>
      <p class="coming-soon" *ngIf="statusMessage">{{ statusMessage }}</p>
      <ul class="placeholder-list" *ngIf="metadata?.placeholders?.length">
        <li *ngFor="let placeholder of metadata?.placeholders">
          {{ placeholder.label }} · bald verfügbar
        </li>
      </ul>
    </nav>
  </aside>

  <main class="quiz-content">
    <section *ngIf="phase === 'loading'" class="state-card glass-panel">
      <div class="spinner"></div>
      <p>Wir sammeln gerade die Fragen ...</p>
    </section>

    <section *ngIf="phase === 'intro'" class="state-card intro glass-panel">
      <h2>Bereit für das Ethik-Quiz?</h2>
      <p>15 kuratierte Fragen live. Stelle sicher, dass dein Name gesetzt ist und starte, wenn du bereit bist.</p>
      <div class="confirm-actions">
        <button type="button" class="primary" (click)="startQuizFlow()">Jetzt starten</button>
      </div>
    </section>

    <section *ngIf="phase === 'error'" class="state-card error glass-panel">
      <p>{{ errorMessage }}</p>
      <button type="button" class="primary" (click)="loadQuestions()">Erneut versuchen</button>
    </section>

    <ng-container *ngIf="phase === 'quiz' && currentQuestion as question">
      <article class="quiz-card glass-panel" #questionCard>
        <header>
          <div class="topic-chip">
            <span class="dot"></span>
            {{ question.topic }}
          </div>
          <div class="question-meta">
            <span class="counter">Frage {{ progressLabel }}</span>
          </div>
        </header>
        <div class="prompt-block">
          <div class="hint-pill" *ngIf="question.multi">
            <span class="icon">◎</span> Mehrfachauswahl möglich
          </div>
          <h2>{{ question.prompt }}</h2>
        </div>
        <div class="choices-grid">
          <button
            type="button"
            class="choice-tile"
            *ngFor="let choice of question.choices"
            [class.selected]="isSelected(question, choice.id)"
            (click)="selectOption(question, choice.id)"
            [attr.aria-pressed]="isSelected(question, choice.id)"
          >
            <div class="choice-head">
              <span class="choice-id">{{ choice.id }}</span>
              <span class="choice-indicator" aria-hidden="true"></span>
            </div>
            <span class="choice-label">{{ choice.text }}</span>
          </button>
        </div>
        <footer>
          <div class="progress-info">
            <span class="count">{{ progressLabel }}</span>
            <div class="bar">
              <div class="fill" [style.width.%]="progressPercent"></div>
            </div>
          </div>
          <div class="actions">
            <button type="button" class="ghost" (click)="goBack()" [disabled]="currentIndex === 0">Zurück</button>
            <button type="button" class="primary" (click)="goNext()" [disabled]="!hasSelection">
              {{ currentIndex === questions.length - 1 ? 'Weiter zur Bestätigung' : 'Weiter' }}
            </button>
          </div>
        </footer>
      </article>
      <p class="validation" *ngIf="errorMessage">{{ errorMessage }}</p>
    </ng-container>

    <section *ngIf="phase === 'confirm'" class="state-card confirm glass-panel">
      <h2>Geschafft! Möchtest du einreichen?</h2>
      <p>Du hast alle Fragen beantwortet. Prüfe deine Auswahl oder reiche jetzt deine Antworten ein.</p>
      <p class="validation" *ngIf="errorMessage">{{ errorMessage }}</p>
      <div class="confirm-actions">
        <button type="button" class="ghost" (click)="goBack()">Noch einmal überprüfen</button>
        <button type="button" class="primary" (click)="submitQuiz()">Fertig einreichen</button>
      </div>
    </section>

    <section *ngIf="phase === 'submitted' && result" class="state-card success glass-panel">
      <h2>Auswertung</h2>
      <p>Du hast {{ result.correct }}/{{ result.total }} richtig.</p>
      <p *ngIf="result.rank !== null; else storedRank">Dein Platz: {{ result.rank }}.</p>
      <ng-template #storedRank>
        <p *ngIf="storageInfo">
          Leaderboard (erster Versuch): Platz {{ storageInfo.leaderboardRank ?? '–' }}.
        </p>
      </ng-template>
      <p class="notice" *ngIf="storageInfo && !storageInfo.stored">
        Nur dein erster Versuch landet im Leaderboard. Dieses Ergebnis wurde nicht gespeichert.
      </p>
      <section class="inline-review glass-panel" *ngIf="submittedReview.length && currentSubmittedQuestion as reviewQuestion">
        <header>
          <div>
            <p class="eyebrow">Direkte Auswertung</p>
            <h3>Frage {{ submittedReviewIndex + 1 }} / {{ submittedReview.length }}</h3>
            <p class="meta">Thema: {{ reviewQuestion.topic }} <span *ngIf="reviewQuestion.multi">· Mehrfachauswahl</span></p>
          </div>
        </header>
        <div class="prompt">
          <p>{{ reviewQuestion.prompt }}</p>
        </div>
        <div class="review-choices">
          <div
            class="review-choice"
            *ngFor="let choice of reviewQuestion.choices"
            [class.correct]="choice.correct"
            [class.incorrect]="choice.selected && !choice.correct"
            [class.is-selected]="choice.selected"
          >
            <div class="choice-head">
              <span class="choice-id">{{ choice.id }}</span>
              <div class="badge-cluster">
                <span class="badge success" *ngIf="choice.correct">Richtig</span>
                <span class="badge danger" *ngIf="choice.selected && !choice.correct">Deine Auswahl</span>
                <span class="badge neutral" *ngIf="choice.selected && choice.correct">Deine Auswahl</span>
              </div>
            </div>
            <span class="choice-text">{{ choice.text }}</span>
          </div>
        </div>
        <div class="review-nav">
          <button type="button" class="ghost" (click)="prevSubmittedQuestion()" [disabled]="submittedReviewIndex === 0">
            Zurück
          </button>
          <button
            type="button"
            class="ghost"
            (click)="nextSubmittedQuestion()"
            [disabled]="submittedReviewIndex === submittedReview.length - 1"
          >
            Weiter
          </button>
        </div>
      </section>
      <div class="leaderboard-preview" *ngIf="leaderboardPreview.length">
        <h3>Top-Ergebnisse</h3>
        <ul>
          <li *ngFor="let entry of leaderboardPreview">
            <span class="rank">#{{ entry.rank }}</span>
            <span class="name">{{ entry.name }}</span>
            <span class="score">{{ formatScore(entry) }}</span>
          </li>
        </ul>
      </div>
      <div class="confirm-actions">
        <a class="primary" routerLink="/quiz/leaderboard">Zum Leaderboard</a>
        <button type="button" class="ghost" (click)="restartQuiz()">Nochmal starten</button>
      </div>
    </section>
  </main>

  <div class="modal-backdrop" *ngIf="showNameModal">
    <div class="modal">
      <h2>Wie dürfen wir dich nennen?</h2>
      <form [formGroup]="nameForm" (ngSubmit)="saveName()">
        <label for="player-name">Name*</label>
        <input
          id="player-name"
          type="text"
          formControlName="name"
          placeholder="z. B. Max"
          maxlength="120"
          required
        />
        <p class="error" *ngIf="nameForm.controls.name.invalid && nameForm.controls.name.touched">
          Name fehlt.
        </p>
        <div class="modal-actions">
          <button type="button" class="ghost" (click)="dismissNameModal()">Abbrechen</button>
          <button type="submit" class="primary">Speichern</button>
        </div>
      </form>
    </div>
  </div>
</div>
